<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>13 - Nested Iteration</title>
  <script type="module" src="../../dist/aft.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 700px; margin: 2rem auto; padding: 0 1rem; }
    .department { background: #f5f5f5; padding: 1rem; margin: 1rem 0; border-radius: 4px; }
    .department h3 { margin: 0 0 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .person { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem;
              background: white; margin: 0.25rem 0; border-radius: 4px; }
    .person input { flex: 1; padding: 0.25rem; }
    .badge { font-size: 0.75rem; background: #e3f2fd; color: #1565c0;
             padding: 2px 8px; border-radius: 10px; }
    button { padding: 0.25rem 0.5rem; cursor: pointer; }
    .add-btn { background: #4caf50; color: white; border: none; border-radius: 4px; }
    .remove-btn { background: none; border: none; color: #999; }
    .remove-btn:hover { color: #f44336; }
    .stats { background: #fff3e0; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
  </style>
</head>
<body>

<h1>13 - Nested Iteration</h1>
<p>Test case for nested <code>aft-each</code> with proper context variable scoping.</p>

<aft-form>
  <aft-data>
  {
    "departments": [
      {
        "name": "Engineering",
        "people": [
          {"name": "Alice", "role": "Lead"},
          {"name": "Bob", "role": "Senior"},
          {"name": "Carol", "role": "Junior"}
        ]
      },
      {
        "name": "Design",
        "people": [
          {"name": "Diana", "role": "Lead"},
          {"name": "Eve", "role": "Senior"}
        ]
      },
      {
        "name": "Marketing",
        "people": [
          {"name": "Frank", "role": "Lead"}
        ]
      }
    ]
  }
  </aft-data>

  <aft-bind name="totalPeople" calc="departments.reduce((sum, d) => sum + d.people.length, 0)"></aft-bind>
  <aft-bind name="totalDepts" calc="departments.length"></aft-bind>

  <div class="stats">
    <strong aft-text="totalDepts"></strong> departments,
    <strong aft-text="totalPeople"></strong> people total
  </div>

  <!-- Outer loop: departments -->
  <div class="department" aft-each="departments" aft-as="dept" aft-index-as="deptIndex">
    <h3>
      <span aft-text="`${deptIndex + 1}. ${dept.name}`"></span>
      <span class="badge" aft-text="`${dept.people.length} people`"></span>
      <button class="add-btn"
              aft-click="dept.people.push({name: 'New Person', role: 'TBD'})">+</button>
      <button class="remove-btn"
              aft-click="departments.splice(deptIndex, 1)"
              aft-show="departments.length > 1">×</button>
    </h3>

    <!-- Inner loop: people within department -->
    <div class="person" aft-each="dept.people" aft-as="person" aft-index-as="personIndex">
      <span aft-text="`${deptIndex + 1}.${personIndex + 1}`"></span>
      <input aft-ref="person.name" placeholder="Name">
      <input aft-ref="person.role" placeholder="Role" style="width: 100px;">
      <button class="remove-btn"
              aft-click="dept.people.splice(personIndex, 1)">×</button>
    </div>

    <p aft-show="dept.people.length === 0" style="color: #999; font-style: italic;">
      No people in this department.
    </p>
  </div>

  <button class="add-btn" style="margin-top: 1rem;"
          aft-click="departments.push({name: 'New Department', people: []})">
    + Add Department
  </button>
</aft-form>

<h2>What This Tests</h2>
<ul>
  <li><strong>Nested context variables</strong>: <code>dept</code>, <code>deptIndex</code> in outer; <code>person</code>, <code>personIndex</code> in inner</li>
  <li><strong>Inner loop accessing outer context</strong>: <code>deptIndex</code> used inside person template</li>
  <li><strong>Mutations at both levels</strong>: Add/remove departments and people</li>
  <li><strong>Path resolution</strong>: <code>dept.people</code> as iteration source</li>
  <li><strong>Computed values over nested data</strong>: Total people across all departments</li>
</ul>

</body>
</html>
